<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chat Interface</title>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        html,body{height:100dvh;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        #root{height:100dvh}
        [contentEditable=true]:empty:before{content:attr(placeholder);color:#9ca3af;pointer-events:none;opacity:.7}
        
        /* Prevent selection, copy, context menu, drag */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        [contentEditable=true] {
            -webkit-user-select: text;
            user-select: text;
        }
        img, video, a {
            pointer-events: none;
        }
        body {
            -webkit-context-menu: none;
            context-menu: none;
        }
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
        * {
            -webkit-touch-callout: none;
        }

        /* Message wrap + metadata aligned to right edge */
        .message-content {
            display: flex;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 4px;
            width: 100%;
            justify-content: flex-end;
        }
        .message-text {
            display: inline;
            white-space: normal;
            word-break: break-word;
            flex: 1;
            min-width: 0;
        }
        .message-metadata {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
            font-size: 0.75rem;
            line-height: 1;
            flex-shrink: 0;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useEffect, useRef, useState } = React;

        const ArrowLeft = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
            </svg>
        );

        const MoreVertical = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
            </svg>
        );

        // Original Microphone Icon (White)
        const MicrophoneIcon = () => (
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6">
                <g id="SVGRepo_bgCarrier" strokeWidth="0"></g>
                <g id="SVGRepo_tracerCarrier" strokeLinecap="round" strokeLinejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M7.25 7C7.25 4.37665 9.37665 2.25 12 2.25C14.6234 2.25 16.75 4.37665 16.75 7V11C16.75 13.6234 14.6234 15.75 12 15.75C9.37665 15.75 7.25 13.6234 7.25 11V7Z" fill="#ffffff"></path>
                    <path d="M5.75 10C5.75 9.58579 5.41421 9.25 5 9.25C4.58579 9.25 4.25 9.58579 4.25 10V11C4.25 15.0272 7.3217 18.3369 11.25 18.7142V21C11.25 21.4142 11.5858 21.75 12 21.75C12.4142 21.75 12.75 21.4142 12.75 21V18.7142C16.6783 18.3369 19.75 15.0272 19.75 11V10C19.75 9.58579 19.4142 9.25 19 9.25C18.5858 9.25 18.25 9.58579 18.25 10V11C18.25 14.4518 15.4518 17.25 12 17.25C8.54822 17.25 5.75 14.4518 5.75 11V10Z" fill="#ffffff"></path>
                </g>
            </svg>
        );

        // Custom Send Arrow Icon (White)
        const SendArrowIcon = () => (
            <svg viewBox="0 -0.5 21 21" className="w-6 h-6">
                <path d="M2.61258 9L0.05132 1.31623C-0.22718 0.48074 0.63218 -0.28074 1.42809 0.09626L20.4281 9.0963C21.1906 9.4575 21.1906 10.5425 20.4281 10.9037L1.42809 19.9037C0.63218 20.2807 -0.22718 19.5193 0.05132 18.6838L2.61258 11H8.9873C9.5396 11 9.9873 10.5523 9.9873 10C9.9873 9.4477 9.5396 9 8.9873 9H2.61258z" fill="#fff" fillRule="evenodd" clipRule="evenodd"></path>
            </svg>
        );

        // ORIGINAL Keyboard SVG - EXACTLY AS BEFORE (Color: #6b7280)
        const KeyboardIcon = () => (
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6">
                <g id="SVGRepo_bgCarrier" strokeWidth="0"></g>
                <g id="SVGRepo_tracerCarrier" strokeLinecap="round" strokeLinejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M7 9C7 9.55228 6.55228 10 6 10C5.44772 10 5 9.55228 5 9C5 8.44772 5.44772 8 6 8C6.55228 8 7 8.44772 7 9Z" fill="#6b7280"></path>
                    <path d="M7 12C7 12.5523 6.55228 13 6 13C5.44772 13 5 12.5523 5 12C5 11.4477 5.44772 11 6 11C6.55228 11 7 11.4477 7 12Z" fill="#6b7280"></path>
                    <path d="M10 12C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12C8 11.4477 8.44772 11 9 11C9.55228 11 10 11.4477 10 12Z" fill="#6b7280"></path>
                    <path d="M10 9C10 9.55228 9.55228 10 9 10C8.44772 10 8 9.55228 8 9C8 8.44772 8.44772 8 9 8C9.55228 8 10 8.44772 10 9Z" fill="#6b7280"></path>
                    <path d="M13 9C13 9.55228 12.5523 10 12 10C11.4477 10 11 9.55228 11 9C11 8.44772 11.4477 8 12 8C12.5523 8 13 8.44772 13 9Z" fill="#6b7280"></path>
                    <path d="M13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12Z" fill="#6b7280"></path>
                    <path d="M16 9C16 9.55228 15.5523 10 15 10C14.4477 10 14 9.55228 14 9C14 8.44772 14.4477 8 15 8C15.5523 8 16 8.44772 16 9Z" fill="#6b7280"></path>
                    <path d="M16 12C16 12.5523 15.5523 13 15 13C14.4477 13 14 12.5523 14 12C14 11.4477 14.4477 11 15 11C15.5523 11 16 11.4477 16 12Z" fill="#6b7280"></path>
                    <path d="M19 9C19 9.55228 18.5523 10 18 10C17.4477 10 17 9.55228 17 9C17 8.44772 17.4477 8 18 8C18.5523 8 19 8.44772 19 9Z" fill="#6b7280"></path>
                    <path d="M19 12C19 12.5523 18.5523 13 18 13C17.4477 13 17 12.5523 17 12C17 11.4477 17.4477 11 18 11C18.5523 11 19 11.4477 19 12Z" fill="#6b7280"></path>
                    <path d="M2 11C2 8.17157 2 6.75736 2.87868 5.87868C3.75736 5 5.17157 5 8 5H16C18.8284 5 20.2426 5 21.1213 5.87868C22 6.75736 22 8.17157 22 11V13C22 15.8284 22 17.2426 21.1213 18.1213C20.2426 19 18.8284 19 16 19H8C5.17157 19 3.75736 19 2.87868 18.1213C2 17.2426 2 15.8284 2 13V11Z" stroke="#6b7280" strokeWidth="1.5"></path>
                    <path d="M7 16H17" stroke="#6b7280" strokeWidth="1.5" strokeLinecap="round"></path>
                </g>
            </svg>
        );

        function ChatHeader({ stickyDate }) {
            return (
                <div className="fixed top-0 left-0 right-0 bg-white shadow-sm z-50 pt-[env(safe-area-inset-top)]">
                    <div className="flex items-center justify-between px-3 py-2">
                        <button className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft/></button>
                        <div className="flex items-center flex-1 mx-3">
                            <div className="w-11 h-11 rounded-full bg-orange-400 flex items-center justify-center flex-shrink-0">
                                <span className="text-white font-medium text-base">DS</span>
                            </div>
                            <div className="ml-3 flex-1 min-w-0">
                                <h1 className="text-gray-900 font-medium text-base leading-tight">Daddy Steve</h1>
                                <p className="text-gray-500 text-sm leading-tight">last seen within a week</p>
                            </div>
                        </div>
                        <button className="p-2 hover:bg-gray-100 rounded-full transition-colors"><MoreVertical/></button>
                    </div>

                    <div className={`absolute left-1/2 transform -translate-x-1/2 transition-opacity duration-200 pointer-events-none ${stickyDate ? 'opacity-100' : 'opacity-0'}`}
                         style={{ bottom: '-32px' }}>
                        <div className="px-4 rounded-full flex items-center shadow-sm" style={{ 
                            backgroundColor: '#749cbf',
                            minHeight: '26px',
                            height: '26px'
                        }}>
                            <span className="text-white text-xs font-medium" style={{ lineHeight: '1' }}>{stickyDate || 'June 6'}</span>
                        </div>
                    </div>
                </div>
            );
        }

        function ChatLayout() {
            const scrollRef = useRef(null);
            const inputRef = useRef(null);
            const inputContainerRef = useRef(null);
            const [stickyDate, setStickyDate] = useState(null);
            const [isScrolling, setIsScrolling] = useState(false);
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const [hasText, setHasText] = useState(false);
            const [messages, setMessages] = useState([
                { text: 'Bro', time: '1:38 PM', incoming: true },
                { text: 'Hey', time: '1:39 PM', incoming: false }
            ]);
            let scrollTimeout = useRef(null);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            useEffect(() => {
                const input = inputRef.current;
                const container = inputContainerRef.current;
                const chat = scrollRef.current;

                if (!input || !container || !chat) return;

                const handleInput = () => {
                    const text = input.textContent || '';
                    setHasText(text.trim().length > 0);

                    // Enforce max 20 characters
                    if (text.length > 20) {
                        input.textContent = text.substring(0, 20);
                        const range = new Range();
                        range.selectNodeContents(input);
                        range.collapse(false);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }

                    input.style.height = 'auto';
                    const newHeight = Math.min(input.scrollHeight, 100);
                    input.style.height = `${newHeight}px`;
                    container.style.height = `${newHeight + 24}px`;
                    const bottomPadding = newHeight + 32 + (showEmojiPicker ? 280 : 0);
                    chat.style.paddingBottom = `${bottomPadding}px`;
                };

                input.addEventListener('input', handleInput);
                input.addEventListener('paste', () => setTimeout(handleInput, 0));
                handleInput();

                return () => {
                    input.removeEventListener('input', handleInput);
                };
            }, [showEmojiPicker]);

            useEffect(() => {
                const chat = scrollRef.current;
                if (!chat) return;

                const dateBadges = chat.querySelectorAll('.chat-date');
                const headerHeight = 80;
                let currentStickyDate = null;

                const checkStickyDate = () => {
                    setIsScrolling(true);
                    clearTimeout(scrollTimeout.current);

                    let newStickyDate = null;
                    dateBadges.forEach(badge => {
                        const rect = badge.getBoundingClientRect();
                        const badgeTop = rect.top;
                        if (badgeTop <= headerHeight + 10 && badgeTop + rect.height > headerHeight - 20) {
                            newStickyDate = badge.textContent.trim();
                        }
                    });

                    if (newStickyDate !== currentStickyDate) {
                        setStickyDate(newStickyDate);
                        currentStickyDate = newStickyDate;
                    }

                    scrollTimeout.current = setTimeout(() => {
                        setIsScrolling(false);
                        setStickyDate(null);
                    }, 800);
                };

                chat.addEventListener('scroll', checkStickyDate);
                return () => chat.removeEventListener('scroll', checkStickyDate);
            }, []);

            const toggleEmojiPicker = () => {
                const willOpen = !showEmojiPicker;
                setShowEmojiPicker(willOpen);
                if (inputRef.current) inputRef.current.blur();
                setTimeout(() => inputRef.current?.blur(), 100);
            };

            const closeEmojiPicker = () => setShowEmojiPicker(false);

            const handleInputClick = () => {
                if (showEmojiPicker) closeEmojiPicker();
            };

            const sendMessage = () => {
                const text = inputRef.current?.textContent?.trim();
                if (!text || text.length === 0) return;

                const newMsg = {
                    text: text.substring(0, 20),
                    time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                    incoming: false
                };
                setMessages(prev => [...prev, newMsg]);
                inputRef.current.textContent = '';
                setHasText(false);
                if (inputRef.current) {
                    inputRef.current.style.height = 'auto';
                    inputContainerRef.current.style.height = '48px';
                }
            };

            // REMOVED: Enter key send (only button sends)
            const handleMouseDown = (e) => e.preventDefault();
            const handleChatClick = (e) => e.preventDefault();

            return (
                <div className="flex flex-col h-dvh bg-gray-50 relative">
                    <ChatHeader stickyDate={isScrolling ? stickyDate : null} />

                    <div ref={scrollRef}
                         onMouseDown={handleChatClick}
                         onTouchStart={handleChatClick}
                         className="flex-1 overflow-y-auto pt-20 px-4 transition-padding duration-300"
                         style={{
                             backgroundImage:'url(https://i.ibb.co/hxsGq3LC/Screenshot-20251105-115744.jpg)',
                             backgroundSize:'cover',
                             backgroundPosition:'center',
                             backgroundRepeat:'no-repeat',
                             paddingBottom: '64px',
                             transition: 'padding-bottom 300ms ease'
                         }}>
                        <div className="flex flex-col justify-end min-h-full space-y-4 py-4">
                            <div className="flex justify-center">
                                <div className="px-4 py-2 rounded-full flex items-center shadow-sm chat-date" style={{backgroundColor:'#749cbf',minHeight:'30px'}}>
                                    <span className="text-white text-xs font-medium" style={{lineHeight:'1'}}>June 16</span>
                                </div>
                            </div>

                            {messages.map((msg, i) => (
                                <div key={i} className={`flex items-end gap-2 ${msg.incoming ? '' : 'justify-end'}`}
                                     onMouseDown={handleMouseDown}
                                     onTouchStart={handleMouseDown}>
                                    <div className={`rounded-2xl ${msg.incoming ? 'rounded-bl-md bg-white' : 'rounded-br-md'} px-4 py-2 shadow-sm max-w-xs`}
                                         style={msg.incoming ? {} : {backgroundColor:'#5d7d99'}}>
                                        <div className="message-content">
                                            <span className={`message-text ${msg.incoming ? 'text-gray-900' : 'text-white'} text-base`}>
                                                {msg.text}
                                            </span>
                                            <div className={`message-metadata ${msg.incoming ? 'text-gray-400' : 'text-blue-100'}`}>
                                                <span>{msg.time}</span>
                                                {!msg.incoming && (
                                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-4 h-4">
                                                        <g clipPath="url(#clip0_949_23339)">
                                                            <path d="M17.5821 6.95711C17.9726 6.56658 17.9726 5.93342 17.5821 5.54289C17.1916 5.15237 16.5584 5.15237 16.1679 5.54289L5.54545 16.1653L1.70711 12.327C1.31658 11.9365 0.683417 11.9365 0.292893 12.327C-0.0976311 12.7175 -0.097631 13.3507 0.292893 13.7412L4.83835 18.2866C5.22887 18.6772 5.86204 18.6772 6.25256 18.2866L17.5821 6.95711Z" fill="#9ebad2"/>
                                                            <path d="M23.5821 6.95711C23.9726 6.56658 23.9726 5.93342 23.5821 5.54289C23.1915 5.15237 22.5584 5.15237 22.1678 5.54289L10.8383 16.8724C10.4478 17.263 10.4478 17.8961 10.8383 18.2866C11.2288 18.6772 11.862 18.6772 12.2525 18.2866L23.5821 6.95711Z" fill="#9ebad2"/>
                                                        </g>
                                                        <defs><clipPath id="clip0_949_23339"><rect width="24" height="24" fill="white"/></clipPath></defs>
                                                    </svg>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Bottom Input + Send Button */}
                    <div className="fixed bottom-0 left-0 right-0 z-40 pb-[env(safe-area-inset-bottom)] transition-transform duration-300"
                         style={{
                             backgroundImage:'url(https://i.ibb.co/hxsGq3LC/Screenshot-20251105-115744.jpg)',
                             backgroundSize:'cover',
                             backgroundPosition:'center',
                             backgroundRepeat:'no-repeat',
                             paddingTop:'8px',
                             paddingBottom:'8px',
                             transform: showEmojiPicker ? 'translateY(-280px)' : 'translateY(0)',
                         }}>
                        <div className="mx-3 flex items-center gap-2">
                            <div ref={inputContainerRef}
                                 className="bg-white shadow-sm flex items-center px-3 py-3 transition-all duration-100 flex-1"
                                 style={{
                                     borderRadius:'13px',
                                     minHeight:'48px',
                                     height:'48px',
                                     overflow:'hidden'
                                 }}>
                                <button 
                                    className="text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0 mr-3 p-1"
                                    onMouseDown={handleMouseDown}
                                    onTouchStart={handleMouseDown}
                                    onClick={toggleEmojiPicker}>
                                    {showEmojiPicker ? (
                                        <KeyboardIcon />
                                    ) : (
                                        <i className="fa-regular fa-face-smile text-2xl"></i>
                                    )}
                                </button>
                                <div 
                                    ref={inputRef}
                                    contentEditable="true"
                                    placeholder="Message"
                                    className="flex-1 outline-none text-gray-900 text-base"
                                    onClick={handleInputClick}
                                    onFocus={handleInputClick}
                                    style={{
                                        minHeight:'24px',
                                        maxHeight:'100px',
                                        overflowY:'auto',
                                        resize:'none',
                                        lineHeight:'1.5'
                                    }}>
                                </div>
                                <button className="text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0 ml-3"
                                        onMouseDown={handleMouseDown}
                                        onTouchStart={handleMouseDown}>
                                    <i className="fa-solid fa-paperclip text-2xl"></i>
                                </button>
                            </div>
                            <button 
                                className="w-12 h-12 flex-shrink-0 flex items-center justify-center shadow-sm transition-all duration-200 rounded-full" 
                                onMouseDown={handleMouseDown}
                                onTouchStart={handleMouseDown}
                                onClick={hasText ? sendMessage : null}
                                style={{
                                    backgroundColor: hasText ? '#749cbf' : '#e5e7eb',
                                    opacity: hasText ? 1 : 0.6,
                                    cursor: hasText ? 'pointer' : 'default'
                                }}
                                disabled={!hasText}>
                                {hasText ? <SendArrowIcon /> : <MicrophoneIcon />}
                            </button>
                        </div>
                    </div>

                    {/* Emoji Picker */}
                    <div 
                        className={`fixed bottom-0 left-0 right-0 bg-white z-30 transition-transform duration-300 ease-out ${
                            showEmojiPicker ? 'translate-y-0' : 'translate-y-full'
                        }`}
                        style={{
                            height: '280px',
                            boxShadow: '0 -2px 10px rgba(0,0,0,0.1)',
                            backgroundColor: '#ffffff',
                        }}>
                        <div className="h-full flex items-center justify-center text-gray-400 text-sm">
                            {/* Empty space */}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatLayout/>);
    </script>
</body>
</html>
